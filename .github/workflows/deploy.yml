name: Deploy to Netlify

on:
  # main ë¸Œëœì¹˜: í”„ë¡œë•ì…˜ ë°°í¬
  # develop ë¸Œëœì¹˜: ë¯¸ë¦¬ë³´ê¸° ë°°í¬
  push:
    branches:
      - main
      - develop
    # ì„ íƒì : íŠ¹ì • ê²½ë¡œ ë³€ê²½ ì‹œì—ë§Œ ë°°í¬ (ë¹Œë“œ íšŸìˆ˜ ì ˆì•½)
    # paths:
    #   - 'app/**'
    #   - 'public/**'
    #   - 'package.json'
    #   - 'vite.config.ts'

  # ìˆ˜ë™ ì‹¤í–‰ ì˜µì…˜ (Actions íƒ­ì—ì„œ ì§ì ‘ ì‹¤í–‰ ê°€ëŠ¥)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

# ë™ì‹œ ë°°í¬ ë°©ì§€ (ê°™ì€ ë¸Œëœì¹˜ì—ì„œëŠ” í•œ ë²ˆì— í•˜ë‚˜ë§Œ)
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm' # npm ìºì‹œ í™œì„±í™”ë¡œ ë¹Œë“œ ì‹œê°„ ë‹¨ì¶•

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: npm ci

      # 4. íƒ€ì… ì²´í¬
      - name: Type check
        run: npm run typecheck

      # 5. ë¦°íŠ¸ ì²´í¬
      - name: Lint check
        run: npm run lint

      # 6. ë¹Œë“œ
      - name: Build
        run: npm run build
        env:
          NODE_ENV: production

      # 7. Netlifyì— ë°°í¬
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: './build/client'
          production-branch: main
          production-deploy: ${{ github.ref == 'refs/heads/main' }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: |
            Deploy from GitHub Actions
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.event.head_commit.message }}
          enable-pull-request-comment: false
          enable-commit-comment: true
          enable-commit-status: true
          overwrites-pull-request-comment: false
          alias: ${{ github.ref == 'refs/heads/develop' && 'develop-preview' || '' }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 10
        id: netlify-deploy

      # 8. ë°°í¬ ê²°ê³¼ ì•Œë¦¼
      - name: Deployment Summary
        if: success()
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "âœ… Successfully deployed to Production!"
            echo "ğŸŒ Production URL: https://hyeongjin.me"
            echo "ğŸ“ Netlify URL: https://hyeongjin.netlify.app"
          else
            echo "âœ… Successfully deployed to Preview!"
            echo "ğŸ” Preview URL: ${{ steps.netlify-deploy.outputs.deploy-url }}"
          fi
