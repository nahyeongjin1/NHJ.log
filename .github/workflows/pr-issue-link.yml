name: Link PR to Issue

on:
  pull_request:
    types: [opened, edited]

jobs:
  link-issue:
    name: Auto-link to GitHub Issue
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      issues: write
      contents: read

    steps:
      - name: Extract Issue Number from Branch
        id: extract
        env:
          BRANCH_NAME: ${{ github.head_ref }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          echo "ğŸ” Branch: $BRANCH_NAME"
          echo "ğŸ” Title: $PR_TITLE"

          # ë¸Œëœì¹˜ ì´ë¦„ì—ì„œ ì´ìŠˆ ë²ˆí˜¸ ì¶”ì¶œ
          # íŒ¨í„´: feature/BLOG-6, bugfix/BLOG-10, hotfix/BLOG-5
          if [[ $BRANCH_NAME =~ (feature|bugfix|hotfix)/BLOG-([0-9]+) ]]; then
            ISSUE_NUM="${BASH_REMATCH[2]}"
            BRANCH_TYPE="${BASH_REMATCH[1]}"
            echo "âœ… Found issue #$ISSUE_NUM from branch ($BRANCH_TYPE)"
            echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "branch_type=$BRANCH_TYPE" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PR ì œëª©ì—ì„œ ì¶”ì¶œ (ì˜ˆ: "[FEATURE] add feature #6")
          if [[ $PR_TITLE =~ \#([0-9]+) ]]; then
            ISSUE_NUM="${BASH_REMATCH[1]}"
            echo "âœ… Found issue #$ISSUE_NUM from title"
            echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # PR ë³¸ë¬¸ì—ì„œ ì¶”ì¶œ (Closes #6, Fixes #6, Resolves #6)
          if [[ $PR_BODY =~ ([Cc]loses|[Ff]ixes|[Rr]esolves)[[:space:]]\#([0-9]+) ]]; then
            ISSUE_NUM="${BASH_REMATCH[2]}"
            echo "âœ… Found issue #$ISSUE_NUM from body"
            echo "issue_number=$ISSUE_NUM" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âš ï¸ No issue number found"
          echo "found=false" >> $GITHUB_OUTPUT

      - name: Check if Issue Exists
        if: steps.extract.outputs.found == 'true'
        id: check-issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.extract.outputs.issue_number }};
            try {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });

              console.log(`âœ… Issue #${issueNumber} exists`);
              console.log(`   Title: ${issue.data.title}`);
              console.log(`   State: ${issue.data.state}`);
              console.log(`   Labels: ${issue.data.labels.map(l => l.name).join(', ')}`);

              core.setOutput('exists', 'true');
              core.setOutput('issue_title', issue.data.title);
              core.setOutput('issue_state', issue.data.state);

              return true;
            } catch (error) {
              console.log(`âŒ Issue #${issueNumber} not found`);
              core.setOutput('exists', 'false');
              return false;
            }

      - name: Update PR Title with Issue Number
        if: steps.extract.outputs.found == 'true' && steps.check-issue.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.extract.outputs.issue_number }};
            const issueTitle = `${{ steps.check-issue.outputs.issue_title }}`;
            const currentPrTitle = context.payload.pull_request.title;

            // ì´ë¯¸ [BLOG-N] í˜•ì‹ì´ ìˆëŠ”ì§€ í™•ì¸
            const hasIssuePrefixPattern = /^\[BLOG-\d+\]/;

            if (hasIssuePrefixPattern.test(currentPrTitle)) {
              console.log('âœ… PR title already has issue number prefix');
              return;
            }

            // Issue ì œëª©ì—ì„œ [FEATURE], [BUG] ê°™ì€ prefix ì œê±°
            const cleanIssueTitle = issueTitle.replace(/^\[(FEATURE|BUG|DOCS|REFACTOR|CHORE)\]\s*/i, '');

            // ìƒˆ PR ì œëª© ìƒì„±: [BLOG-6] Issue ì œëª©
            const newPrTitle = `[BLOG-${issueNumber}] ${cleanIssueTitle}`;

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              title: newPrTitle
            });

            console.log(`âœ… Updated PR title to: ${newPrTitle}`);

      - name: Update PR Description with Issue Link
        if: steps.extract.outputs.found == 'true' && steps.check-issue.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.extract.outputs.issue_number }};
            const issueTitle = `${{ steps.check-issue.outputs.issue_title }}`;
            const prBody = context.payload.pull_request.body || '';

            // ì´ë¯¸ ì‹¤ì œ ì´ìŠˆ ë²ˆí˜¸ê°€ ë§í¬ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
            const hasValidIssueLink = /([Cc]loses|[Ff]ixes|[Rr]esolves)\s*#\d+/.test(prBody);

            if (hasValidIssueLink) {
              console.log('âœ… Issue link already exists in PR body');
              return;
            }

            // HTML ì£¼ì„ ì œê±°í•œ ë²„ì „ìœ¼ë¡œ íŒ¨í„´ ì²´í¬ (ì£¼ì„ ë‚´ë¶€ í…ìŠ¤íŠ¸ëŠ” ë¬´ì‹œ)
            const prBodyWithoutComments = prBody.replace(/<!--[\s\S]*?-->/g, '');

            // "Closes #" íŒ¨í„´ ì°¾ê¸° (í…œí”Œë¦¿ì— ìˆëŠ” ë¹ˆ ìƒíƒœ)
            // íŒ¨í„´: "Closes #" ë’¤ì— ìˆ«ìê°€ ì—†ëŠ” ê²½ìš°
            const emptyClosesPattern = /Closes\s*#\s*(?!\d)/;

            let newBody;

            if (emptyClosesPattern.test(prBodyWithoutComments)) {
              // "Closes #" ë¥¼ "Closes #N"ìœ¼ë¡œ êµì²´ (ì›ë³¸ì—ì„œ êµì²´, ì²« ë²ˆì§¸ë§Œ)
              let replaced = false;
              newBody = prBody.replace(/Closes\s*#(?!\d)/, (match) => {
                if (!replaced) {
                  replaced = true;
                  return `Closes #${issueNumber}\n\n> ${issueTitle}`;
                }
                return match;
              });
              console.log(`âœ… Updated "Closes #" to "Closes #${issueNumber}"`);
            } else {
              // PR ë³¸ë¬¸ì— ì´ìŠˆ ë§í¬ ì„¹ì…˜ ì¶”ê°€
              const issueLinkSection = `
              ## ğŸ”— Related Issue

              <!-- âš ï¸ ì•„ë˜ ë‚´ìš©ì€ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš” -->

              Closes #${issueNumber}

              > ${issueTitle}
              `.trim();

              newBody = prBody ? `${prBody}\n\n${issueLinkSection}` : issueLinkSection;
              console.log(`âœ… Added new "Related Issue" section`);
            }

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: newBody
            });

            console.log(`âœ… Updated PR description with issue #${issueNumber}`);

      - name: Update Branch Info in PR Body
        if: steps.extract.outputs.found == 'true' && steps.check-issue.outputs.exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // ìµœì‹  PR bodyë¥¼ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸° (ì´ì „ ë‹¨ê³„ì—ì„œ ì—…ë°ì´íŠ¸ëœ ë‚´ìš© ë°˜ì˜)
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const prBody = pr.data.body || '';
            const sourceBranch = context.payload.pull_request.head.ref;
            const targetBranch = context.payload.pull_request.base.ref;

            // Branch ì„¹ì…˜ íŒ¨í„´ ì°¾ê¸° (ì£¼ì„ í¬í•¨)
            const branchSectionPattern = /## ğŸŒ¿ Branch\s*\n(?:<!--.*?-->\s*\n)*\s*-\s*From:.*\n\s*-\s*To:.*/s;

            const newBranchSection = `## ğŸŒ¿ Branch

            <!-- âš ï¸ ì•„ë˜ ë‚´ìš©ì€ ìë™ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš” -->

            - From: \`${sourceBranch}\`
            - To: \`${targetBranch}\``.replace(/^            /gm, '');

            if (branchSectionPattern.test(prBody)) {
              const newBody = prBody.replace(branchSectionPattern, newBranchSection);

              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                body: newBody
              });

              console.log(`âœ… Updated branch info: ${sourceBranch} â†’ ${targetBranch}`);
            } else {
              console.log('âš ï¸ Branch section pattern not found in PR body');
              console.log('PR body:', prBody);
            }

      - name: Comment on Issue with PR Link
        if: steps.extract.outputs.found == 'true' && steps.check-issue.outputs.exists == 'true' && github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.extract.outputs.issue_number }};
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const prUrl = context.payload.pull_request.html_url;
            const prAuthor = context.payload.pull_request.user.login;
            const branchType = '${{ steps.extract.outputs.branch_type }}' || 'unknown';

            const branchTypeEmoji = {
              'feature': 'ğŸš€',
              'bugfix': 'ğŸ›',
              'hotfix': 'ğŸ”¥'
            };

            const commentBody = `
            ${branchTypeEmoji[branchType] || 'ğŸ”—'} **Linked Pull Request**

            **#${prNumber}** ${prTitle}
            ğŸ‘¤ Author: @${prAuthor}
            ğŸ”— [View Pull Request](${prUrl})
            `.trim();

            // ìƒˆ ëŒ“ê¸€ ìƒì„± (openedì¼ ë•Œë§Œ ì‹¤í–‰ë˜ë¯€ë¡œ ì¤‘ë³µ ì²´í¬ ë¶ˆí•„ìš”)
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: commentBody
            });
            console.log(`âœ… Added PR link comment to issue #${issueNumber}`);

      - name: Validate Branch Convention
        if: steps.extract.outputs.found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ github.head_ref }}';

            console.log('âš ï¸ No issue number found in branch name, PR title, or body');
            console.log('');
            console.log('ğŸ“Œ Expected branch naming conventions:');
            console.log('   - feature/BLOG-{issue_number}');
            console.log('   - bugfix/BLOG-{issue_number}');
            console.log('   - hotfix/BLOG-{issue_number}');
            console.log('');
            console.log(`Current branch: ${branchName}`);
            console.log('');
            console.log('ğŸ’¡ Tip: Include issue number in branch name or PR description');
            console.log('   Example: "Closes #123" in PR body');

            // PRì— ê²½ê³  ëŒ“ê¸€ ì¶”ê°€
            const warningComment = `
            ## âš ï¸ Issue Link Not Found

            This PR does not seem to be linked to any GitHub issue.

            ### ğŸ“Œ Recommended Actions:
            1. Follow branch naming convention:
               - \`feature/BLOG-{issue_number}\`
               - \`bugfix/BLOG-{issue_number}\`
               - \`hotfix/BLOG-{issue_number}\`

            2. Or add to PR description:
               - \`Closes #123\`
               - \`Fixes #123\`
               - \`Resolves #123\`

            3. Create a related issue if one doesn't exist

            ---
            Current branch: \`${branchName}\`
            `.trim();

            // ê¸°ì¡´ ê²½ê³  ëŒ“ê¸€ í™•ì¸
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const existingWarning = comments.data.find(comment =>
              comment.body.includes('Issue Link Not Found') &&
              comment.user.login === 'github-actions[bot]'
            );

            if (!existingWarning) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: warningComment
              });
              console.log('âœ… Added warning comment to PR');
            }
